<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalles del Set — BrickMaster</title>
  <link rel="stylesheet" href="style.css"> 
</head>
<body>
  <div class="sidebar">
    <a href="index.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
        <span>Inicio</span>
    </a>
    <a href="catalogo.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 6a1 1 0 011-1h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V6zM5 15h10v2a1 1 0 001 1H4a1 1 0 001-1v-2z"></path></svg>
        <span>Catálogo</span>
    </a>
    <a href="coleccion.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
        <span>Colección</span>
    </a>
    <a href="usuario.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
        <span>Usuario</span>
    </a>
  </div>

  <header>
    <div class="brand">
      <div class="logo">INFO</div>
      <div>
        <div class="title" id="setTitle">Cargando Set...</div>
        <div class="subtitle" id="setID">ID: —</div>
      </div>
    </div>
  </header>
  
  <main>
    <div class="detail-container">
        <div class="set-image-col">
            <div id="imagePlaceholder" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; color: var(--muted);">
                Cargando imagen...
            </div>
            
            <h2 id="set_name_display" style="margin-top: 15px; text-align: center;"></h2>
            
            <div class="stat-box-grid" style="margin-top: 15px; width: 100%;">
                <div class="stat-box" style="grid-column: 1 / -1;">
                    <span class="value" id="collectionStatusText">NO AGREGADO</span>
                    <span class="label">ESTADO DE COLECCIÓN</span>
                </div>
            </div>

            <button class="btn" id="addToCollectionBtn" style="margin-top: 20px; width: 100%; font-size: 16px;">
                Agregar a mi Colección
            </button>
            
            <a id="buyLink" target="_blank" class="btn ghost" style="margin-top: 10px; width: 100%; text-align: center; color: var(--accent); border-color: var(--accent);">
                Ver en BrickLink (Piezas/Precios)
            </a>
            
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 15px; width: 100%;">
                <button class='btn tiny-btn' id="favBtn" style="flex:1;">Marcar como Favorito (☆)</button>
                <button class='btn tiny-btn' id="removeBtn" style="flex:1; background:#ef4444; color: white;">Quitar de Colección</button>
            </div>
        </div>

        <div class="set-details-col">
            <div id="generalInfo">
                <h3 class="section-title">Información General</h3>
                <div class="stat-box-grid" id="detailStats">
                    </div>
                
                <h3 class="section-title" style="margin-top: 25px;">Descripción</h3>
                <p id="descriptionText" style="color: var(--muted);"></p>
            </div>
            
            <h3 class="section-title" style="margin-top: 25px;">Inventario de Piezas</h3>
            <div class="parts-list" id="partsList">
                <div style="text-align:center; color: var(--muted);">Cargando inventario...</div>
            </div>
        </div>
    </div>
  </main>

  <script>
    // --- CONFIG ---
    const API_KEY = '1e6240a0d3dc2d161d3463cf24e830a8';
    const BASE = 'https://rebrickable.com/api/v3/lego';
    
    // Estado
    // El set existe como clave si está en la colección: { '76131-1': { isFavorite: true } }
    let inventory = JSON.parse(localStorage.getItem('legoInventory')) || {}; 
    let currentSetNum = '';

    // --- UTILITIES ---
    function fmt(n){return n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
    function saveInventory(){ localStorage.setItem('legoInventory', JSON.stringify(inventory)); }
    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ''; }
    
    async function apiFetch(path){
      const res = await fetch(BASE + path, {headers: {'Authorization': `key ${API_KEY}`}});
      if(!res.ok){
        const text = await res.text();
        throw new Error('API error: '+res.status+' - '+text);
      }
      return res.json();
    }
    
    // --- COLECCIÓN MANAGEMENT (Presence/Absence Only) ---
    function addToCollection(setnum){
        if(inventory[setnum]) { 
            alert('¡El set ya está en tu colección!');
            return;
        }
        // Lo agregamos por primera vez.
        inventory[setnum] = { isFavorite: false }; 
        saveInventory();
        updateCollectionStatus(setnum);
        alert('¡Set agregado a tu colección!');
    }
    
    function toggleFavorite(setnum){
        if(!inventory[setnum]) return;
        inventory[setnum].isFavorite = !inventory[setnum].isFavorite;
        saveInventory();
        updateCollectionStatus(setnum);
    }

    function removeSet(setnum){
        if(confirm(`¿Estás seguro de que quieres QUITAR el set ${setnum} de tu colección?`)){
            delete inventory[setnum];
            saveInventory();
            updateCollectionStatus(setnum);
        }
    }

    // --- UI UPDATES ---
    function updateCollectionStatus(setnum){
        const isPresent = !!inventory[setnum];
        const isFav = isPresent ? inventory[setnum].isFavorite : false;
        
        const btn = document.getElementById('addToCollectionBtn');
        const favBtn = document.getElementById('favBtn');
        const removeBtn = document.getElementById('removeBtn');
        const statusText = document.getElementById('collectionStatusText');
        
        if (isPresent) {
            // Está en colección
            statusText.innerText = 'AGREGADO A LA COLECCIÓN';
            statusText.style.color = '#10b981';
            
            btn.innerText = `Set Agregado (✓)`;
            btn.disabled = true;
            btn.style.backgroundColor = 'var(--muted)';
            
            removeBtn.disabled = false;
            favBtn.disabled = false;
        } else {
            // No está en colección
            statusText.innerText = 'NO AGREGADO';
            statusText.style.color = 'var(--muted)';
            
            btn.innerText = `Agregar a mi Colección`;
            btn.disabled = false;
            btn.style.backgroundColor = 'var(--accent)';
            
            removeBtn.disabled = true;
            favBtn.disabled = true;
        }
        
        // Estado de Favorito
        favBtn.innerText = isFav ? `Favorito (★)` : `Marcar como Favorito (☆)`;
        favBtn.style.backgroundColor = isFav ? '#0ea5e9' : 'var(--card)';
        favBtn.style.color = isFav ? 'white' : 'var(--muted)';
        if (!isPresent) { favBtn.style.backgroundColor = 'var(--card)'; favBtn.style.color = 'var(--muted)'; }
    }

    // --- FETCH & RENDER ---
    async function loadSetDetails(setnum){
        try{
            // 1. Cargar detalles del set
            const setDetail = await apiFetch(`/sets/${encodeURIComponent(setnum)}/`);
            
            document.getElementById('setTitle').innerText = escapeHtml(setDetail.name) || 'Set sin nombre';
            document.getElementById('set_name_display').innerText = escapeHtml(setDetail.name) || 'Set sin nombre';
            document.getElementById('setID').innerText = `ID: ${setDetail.set_num || '—'}`;
            // Mantenemos numParts como referencia del set.
            const partsInSet = fmt(setDetail.num_parts) || '—';
            
            const imgEl = document.createElement('img');
            imgEl.src = setDetail.set_img_url || '';
            imgEl.alt = escapeHtml(setDetail.name);
            document.getElementById('imagePlaceholder').innerHTML = '';
            document.getElementById('imagePlaceholder').appendChild(imgEl);
            
            // 2. Información General
            const detailStats = document.getElementById('detailStats');
            detailStats.innerHTML = `
                <div class="stat-box">
                    <span class="value">${setDetail.year_released || '—'}</span>
                    <span class="label">Año de Lanzamiento</span>
                </div>
                <div class="stat-box">
                    <span class="value">${partsInSet}</span>
                    <span class="label">Piezas del Set</span>
                </div>
                <div class="stat-box">
                    <span class="value">${setDetail.theme_id || '—'}</span>
                    <span class="label">ID Temática</span>
                </div>
            `;
            
            document.getElementById('descriptionText').innerText = `El set ${setDetail.set_num} (${setDetail.name}) es parte de la temática con ID ${setDetail.theme_id} y fue lanzado en ${setDetail.year_released}. Cuenta con ${setDetail.num_parts} piezas.`;

            // 3. Inventario de Piezas
            await loadPartsInventory(setnum);
            
            // 4. Conectar botones de acción y estado de colección
            currentSetNum = setnum;
            updateCollectionStatus(setnum);
            
            document.getElementById('addToCollectionBtn').addEventListener('click', () => { addToCollection(currentSetNum); });
            document.getElementById('favBtn').addEventListener('click', () => { toggleFavorite(currentSetNum); });
            document.getElementById('removeBtn').addEventListener('click', () => { removeSet(currentSetNum); });
            
            // Link externo (BrickLink)
            const bricklinkURL = setDetail.set_num ? `https://www.bricklink.com/v2/catalog/catalogitem.page?S=${setDetail.set_num}` : '#';
            document.getElementById('buyLink').href = bricklinkURL;

        } catch(err){
            document.getElementById('setTitle').innerText = 'Error al cargar el Set';
            document.getElementById('setID').innerText = `ID: ${setnum} (No encontrado)`;
            document.getElementById('imagePlaceholder').innerHTML = `<div style="color:red;">Error: Set no encontrado o problemas de conexión.</div>`;
            console.error(err);
        }
    }

    async function loadPartsInventory(setnum){
        const partsList = document.getElementById('partsList');
        try{
            const inventoryData = await apiFetch(`/sets/${encodeURIComponent(setnum)}/parts/`);
            const parts = inventoryData.results || [];
            partsList.innerHTML = '';
            
            if(parts.length === 0){
                partsList.innerHTML = `<div style="text-align:center; color: var(--muted);">No se encontró un inventario de piezas para este set.</div>`;
                return;
            }
            
            parts.forEach(partItem => {
                const part = partItem.part;
                const color = partItem.color;
                const qty = partItem.quantity;
                
                const el = document.createElement('div'); el.className='parts-item';
                el.innerHTML = `
                    <img src='${part.part_img_url || ''}' class='part-img' alt='${escapeHtml(part.name)}'/>
                    <div class='part-details'>
                        <div class='name'>${escapeHtml(part.name)}</div>
                        <div class='info'>Color: ${escapeHtml(color.name)} (${color.id}) | ID Pieza: ${part.part_num}</div>
                    </div>
                    <div class='part-qty'>x${fmt(qty)}</div>
                `;
                partsList.appendChild(el);
            });
            
        } catch(err){
            partsList.innerHTML = `<div style="text-align:center; color:red;">Error cargando el inventario de piezas.</div>`;
            console.error(err);
        }
    }

    // Init
    (function init(){ 
        const params = new URLSearchParams(window.location.search);
        const setNum = params.get('set_num');
        if (setNum) {
            loadSetDetails(setNum);
        } else {
            document.getElementById('setTitle').innerText = 'Set no especificado';
            document.getElementById('setID').innerText = 'Por favor, proporciona un set_num en la URL.';
        }
    })();
  </script>
</body>
</html>
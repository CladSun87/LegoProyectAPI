<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Colección — BrickMaster</title>
  <link rel="stylesheet" href="style.css"> 
</head>
<body>
  <div class="sidebar">
    <a href="index.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
        <span>Inicio</span>
    </a>
    <a href="catalogo.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 6a1 1 0 011-1h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V6zM5 15h10v2a1 1 0 001 1H4a1 1 0 001-1v-2z"></path></svg>
        <span>Catálogo</span>
    </a>
    <a href="coleccion.html" class="active">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
        <span>Colección</span>
    </a>
    <a href="usuario.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
        <span>Usuario</span>
    </a>
  </div>

  <header>
    <div class="brand">
      <div class="logo" style="background: #10b981;">MY</div>
      <div>
        <div class="title">Mis Sets de LEGO</div>
        <div class="subtitle">Sets que has agregado a tu colección personal.</div>
      </div>
    </div>
  </header>
  
  <main>
    <div class="controls">
      <div class="search control-group">
        <label for="search">Buscar en mi Colección:</label>
        <div class="search-input-group">
          <input type="search" id="search" placeholder="Nombre o ID Set..." />
          <button class="btn" id="search-btn">Buscar</button> 
        </div>
      </div>
      <div class="control-group">
        <label for="sort">Ordenar por:</label>
        <select id="sort" class="ghost" style="width: 150px;">
          <option value="name">Nombre (A-Z)</option>
          <option value="-name">Nombre (Z-A)</option>
          <option value="-year_released">Más recientes</option>
          <option value="num_parts">Piezas (asc)</option>
        </select>
      </div>
      <div class="control-group">
        <label for="filter_fav">Filtro:</label>
        <select id="filter_fav" class="ghost" style="width: 120px;">
          <option value="all">Mostrar todos</option>
          <option value="fav">Solo favoritos</option>
        </select>
      </div>
      <button class="btn" id="reload">Aplicar Filtros</button>
    </div>

    <div style="margin-bottom: 15px; color: var(--muted);" id="collectionStats">Cargando estadísticas...</div>

    <section class="grid" id="collectionGrid"></section>

    <div class="note" style="margin-top: 20px;">Nota: La información de los sets se obtiene de la caché y de Rebrickable.</div>
  </main>

  <script>
    const API_KEY = '1e6240a0d3dc2d161d3463cf24e830a8';
    const BASE = 'https://rebrickable.com/api/v3/lego';

    // *** CAMBIO: inventory ya no guarda qty, solo isFavorite. ***
    let inventory = JSON.parse(localStorage.getItem('legoInventory')) || {}; 
    let allSetsDetails = []; 

    function fmt(n){return n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
    function saveInventory(){ 
        localStorage.setItem('legoInventory', JSON.stringify(inventory)); 
    }
    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ''; }

    async function apiFetch(path){
      const res = await fetch(BASE + path, {headers: {'Authorization': `key ${API_KEY}`}});
      if(!res.ok){ throw new Error('API error: '+res.status); }
      return res.json();
    }
    
    // Funciones de gestión de inventario
    function removeSet(setnum){
        if(confirm(`¿Estás seguro de que quieres QUITAR el set ${setnum} de tu colección?`)){
            delete inventory[setnum];
            saveInventory();
            (async function(){ 
                allSetsDetails = await fetchCollectionDetails(); 
                filterAndRender(); 
            })();
        }
    }
    
    function toggleFavorite(setnum){
        if(!inventory[setnum]) return;
        inventory[setnum].isFavorite = !inventory[setnum].isFavorite;
        saveInventory();
        filterAndRender(); 
    }

    // 1. Carga los detalles de todos los sets en la colección
    async function fetchCollectionDetails() {
        const setNums = Object.keys(inventory);
        if (setNums.length === 0) return [];

        const promises = setNums.map(setnum => 
            apiFetch(`/sets/${setnum}/`)
            .catch(err => {
                console.warn(`Error fetching details for set ${setnum}:`, err);
                return null; 
            })
        );

        const results = await Promise.all(promises);
        
        return results
            .filter(set => set !== null) 
            .map(set => ({
                ...set, 
                ...inventory[set.set_num],
                full_num_parts: set.num_parts,
                isInCollection: true 
            }));
    }

    // 2. Filtra, ordena y renderiza los sets
    function filterAndRender() {
        const grid = document.getElementById('collectionGrid');
        grid.innerHTML = '<div style="grid-column:1/-1">Aplicando filtros...</div>';
        
        const q = document.getElementById('search').value.toLowerCase().trim();
        const sortKey = document.getElementById('sort').value;
        const filterFav = document.getElementById('filter_fav').value;
        const isDescending = sortKey.startsWith('-');
        const actualSortKey = isDescending ? sortKey.substring(1) : sortKey;

        // FILTRADO
        let filteredSets = allSetsDetails.filter(set => {
            const matchesSearch = set.name.toLowerCase().includes(q) || set.set_num.toLowerCase().includes(q);
            const matchesFav = filterFav === 'all' || (filterFav === 'fav' && set.isFavorite);
            return matchesSearch && matchesFav;
        });

        // ORDENAMIENTO
        filteredSets.sort((a, b) => {
            const valA = a[actualSortKey] || (actualSortKey === 'name' ? '' : -Infinity);
            const valB = b[actualSortKey] || (actualSortKey === 'name' ? '' : -Infinity);
            
            if (actualSortKey === 'name') {
                 const comparison = valA.localeCompare(valB);
                 return isDescending ? -comparison : comparison;
            }

            if (valA < valB) return isDescending ? 1 : -1;
            if (valA > valB) return isDescending ? -1 : 1;
            return 0;
        });

        // RENDERIZADO
        if(filteredSets.length === 0){
            grid.innerHTML = `<div style="grid-column:1/-1;color:var(--muted)">No se encontraron sets en tu colección que coincidan con los filtros.</div>`;
        } else {
            renderCollectionGrid(filteredSets);
        }
        
        updateStats(filteredSets);
    }
    
    function updateStats(sets) {
        // *** CAMBIO: Se cuenta el total de sets únicos ***
        let uniqueSetsCount = sets.length;
        let estimatedParts = sets.reduce((sum, set) => sum + (set.full_num_parts || 0), 0);
        
        document.getElementById('collectionStats').innerHTML = `
            Mostrando ${uniqueSetsCount} sets únicos | Piezas estimadas: ${fmt(estimatedParts)}
        `;
    }


    function renderCollectionGrid(sets) {
        const grid = document.getElementById('collectionGrid');
        grid.innerHTML = '';
        
        sets.forEach(set => {
            const favIcon = set.isFavorite ? '★' : '☆'; 
            const el = document.createElement('article'); el.className='card';
            
            el.innerHTML = `
            <a href="detalles.html?set_num=${set.set_num}" style="text-decoration:none; color:inherit;">
                <div class='imgwrap'>
                    <img src='${set.set_img_url || ''}' alt='${escapeHtml(set.name)}' style='max-width:100%;max-height:100%;object-fit:contain;border-radius:10px'/>
                </div>
            </a>
            <h4 class='product-name'>
                 <a href="detalles.html?set_num=${set.set_num}" style="text-decoration:none; color:inherit;">${escapeHtml(set.name)}</a>
            </h4>
            <p class='product-desc'>
                ID Set: ${set.set_num || '—'} 
                <br>Año: ${set.year_released || '—'} • Piezas: ${fmt(set.full_num_parts) || '—'}
            </p>
            <div class='price-row'>
                <div class='collection-status' style='font-size: 14px; color:#10b981; font-weight:700;'>En Colección</div>
                <div style='display:flex;gap:8px'>
                    <button class='tiny-btn fav-btn' data-setnum='${set.set_num}' title="Marcar como Favorito">${favIcon}</button>
                    <button class='tiny-btn remove-btn' data-setnum='${set.set_num}' style="background:#ef4444; color: white;" title="Quitar Set de Colección">Quitar</button>
                    <a href="detalles.html?set_num=${set.set_num}" class='tiny-btn' style="text-decoration:none; color: var(--muted);">Detalles</a>
                </div>
            </div>
            `;
            grid.appendChild(el);
        });

        // Adjuntar eventos de botones
        document.querySelectorAll('.remove-btn').forEach(b=>b.addEventListener('click',()=>{ removeSet(b.dataset.setnum); }));
        document.querySelectorAll('.fav-btn').forEach(b=>b.addEventListener('click',()=>{ toggleFavorite(b.dataset.setnum); }));
    }

    // UI wiring
    document.getElementById('reload').addEventListener('click', filterAndRender);
    document.getElementById('search-btn').addEventListener('click', filterAndRender);
    document.getElementById('sort').addEventListener('change', filterAndRender);
    document.getElementById('filter_fav').addEventListener('change', filterAndRender);
    
    // Enter en el campo de búsqueda
    document.getElementById('search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { 
        e.preventDefault(); 
        filterAndRender();
      }
    });

    // Init
    (async function init(){ 
        inventory = JSON.parse(localStorage.getItem('legoInventory')) || {};
        const grid = document.getElementById('collectionGrid');
        if (Object.keys(inventory).length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted); text-align: center; margin-top: 30px;">Tu colección está vacía. Ve al Catálogo para agregar sets.</div>';
            document.getElementById('collectionStats').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
        } else {
            grid.innerHTML = '<div style="grid-column:1/-1">Cargando detalles de tu colección desde la API...</div>';
            allSetsDetails = await fetchCollectionDetails(); 
            filterAndRender();
        }
    })();

  </script>
</body>
</html>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo LEGO — BrickMaster</title>
  <meta name="description" content="Catálogo de sets LEGO conectado a la API de Rebrickable. Filtros por temática, búsqueda avanzada y paginación." />
  <link rel="stylesheet" href="style.css"> 
</head>
<body>

  <div class="sidebar">
    <a href="index.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
        <span>Inicio</span>
    </a>
    <a href="catalogo.html" class="active">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 6a1 1 0 011-1h10a1 1 0 011 1v10a1 1 0 01-1 1H5a1 1 0 01-1-1V6zM5 15h10v2a1 1 0 001 1H4a1 1 0 001-1v-2z"></path></svg>
        <span>Catálogo</span>
    </a>
    <a href="coleccion.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
        <span>Colección</span>
    </a>
    <a href="usuario.html">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
        <span>Usuario</span>
    </a>
  </div>

  <header>
    <div class="brand">
      <div class="logo">CAT</div>
      <div>
        <div class="title">Catálogo Oficial de Sets</div>
        <div class="subtitle">Sets disponibles a través de la API de Rebrickable.</div>
      </div>
    </div>
  </header>
  
  <main>
    <div class="controls">
      <div class="search control-group">
        <label for="search">Buscar set:</label>
        <div class="search-input-group">
          <input type="search" id="search" placeholder="Nombre o ID Set..." />
        </div>
      </div>
      <div class="control-group">
        <label for="sort">Ordenar por:</label>
        <select id="sort" class="ghost">
          <option value="-year_released">Más recientes</option>
          <option value="year_released">Más antiguos</option>
          <option value="-num_parts">Más piezas</option>
          <option value="num_parts">Menos piezas</option>
        </select>
      </div>
      <button class="btn" id="reload" style="align-self: flex-end;">Buscar/Actualizar</button>
    </div>

    <div class="theme-list" id="themeList">
      </div>

    <section class="grid" id="catalog"></section>

    <div class="pager" id="pager"></div>
    <div class="note">Nota: Los precios y estado de colección son estimados localmente.</div>
  </main>

  <script>
    // --- CONFIG ---
    const API_KEY = '1e6240a0d3dc2d161d3463cf24e830a8';
    const PAGE_SIZE = 12;
    const BASE = 'https://rebrickable.com/api/v3/lego';

    // Temáticas prioritarias
    const PRIORITY_THEMES = ['Star Wars','Technic','Marvel','Ninjago','City','Creator','Classic','Harry Potter','Friends'];

    // Estado Global
    let themesMap = {}; 
    let activeThemeId = null;
    let currentPage = 1;
    let lastQuery = '';
    let lastSort = '-year_released';
    let inventory = JSON.parse(localStorage.getItem('legoInventory')) || {}; 

    // --- UTILITIES ---
    function fmt(n){return '$'+n.toFixed(2)}
    function estimatePrice(num_parts){ // heurística simple
      if(!num_parts) return 19.99;
      const p = Math.max(9.99, Math.round(num_parts * 0.18 * 100)/100);
      return p;
    }
    function escapeHtml(s){ return s ? s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : ''; }
    
    async function apiFetch(path){
      const res = await fetch(BASE + path, {headers: {'Authorization': `key ${API_KEY}`}});
      if(!res.ok){
        const text = await res.text();
        throw new Error('API error: '+res.status+' - '+text);
      }
      return res.json();
    }
    
    // --- COLECCIÓN (REEMPLAZO DE CARRITO) ---
    function saveInventory(){ localStorage.setItem('legoInventory', JSON.stringify(inventory)); }
    function addToCollection(setnum){
        if(!inventory[setnum]) { inventory[setnum] = { qty: 1, isFavorite: false }; }
        else { inventory[setnum].qty += 1; }
        saveInventory();
        // Recargar la tarjeta para que muestre el estado de colección actualizado
        fetchAndRender(false); 
    }

    // --- THEMES ---
    async function loadThemes(){
      try{
        const data = await apiFetch('/themes/?page_size=500');
        const themes = data.results || [];
        themes.forEach(t=>themesMap[t.name]=t.id);

        const container = document.getElementById('themeList');
        container.innerHTML = '';

        // Botón "Todas"
        const btnAll = document.createElement('button'); btnAll.className='theme-btn active'; btnAll.innerText='Todas'; btnAll.dataset.id='all';
        btnAll.addEventListener('click',()=>{ toggleTheme(btnAll, null); });
        container.appendChild(btnAll);

        // Crea botones para temáticas prioritarias
        PRIORITY_THEMES.forEach(pref =>{
          const match = themes.find(t => t.name.toLowerCase().includes(pref.toLowerCase()));
          if(match){
            const btn = document.createElement('button'); btn.className='theme-btn'; btn.innerText=match.name; btn.dataset.id=match.id;
            btn.addEventListener('click',()=>{ toggleTheme(btn, match.id); });
            container.appendChild(btn);
          }
        });

      }catch(err){
        console.error('loadThemes',err);
        document.getElementById('themeList').innerHTML = '<div style="color:var(--muted)">No se pudieron cargar temáticas.</div>';
      }
    }

    function toggleTheme(button, id){
      // activa/desactiva
      const allBtns = document.querySelectorAll('.theme-btn'); 
      allBtns.forEach(b=>b.classList.remove('active'));
      
      activeThemeId = id;
      button.classList.add('active');
      
      // Limpia la búsqueda para que el filtro por tema funcione
      document.getElementById('search').value = '';
      currentPage = 1; fetchAndRender();
    }

    // --- FETCH & RENDER ---
    async function fetchSets({page=1, search='', ordering=lastSort, themeId=null}={}){
      let url = `/sets/?page=${page}&page_size=${PAGE_SIZE}&ordering=${ordering}`;
      
      const hasSearchQuery = search.length > 0;

      if(hasSearchQuery) {
          // SOLUCIÓN AL BUG: Si hay una búsqueda, IGNORA el filtro de temática (búsqueda global)
          url += `&search=${encodeURIComponent(search)}`;
          themeId = null; // Anula la temática para la llamada API
      } else if (themeId) {
          // Si no hay búsqueda, aplica la temática
          url += `&theme_id=${themeId}`;
      }
      
      const data = await apiFetch(url);
      return data; 
    }

    async function fetchAndRender(resetPage=true){
      const catalog = document.getElementById('catalog');
      catalog.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Cargando sets...</div>';
      
      if(resetPage) currentPage = 1;
      
      const q = document.getElementById('search').value.trim(); lastQuery = q;
      lastSort = document.getElementById('sort').value;
      
      try{
        const data = await fetchSets({page:currentPage, search:q, ordering:lastSort, themeId: activeThemeId});
        renderCatalog(data);
        renderPager(data);
        
        // Si hay una búsqueda, desactiva visualmente el botón de tema activo
        const allBtns = document.querySelectorAll('.theme-btn');
        if (q.length > 0) {
             allBtns.forEach(b => b.classList.remove('active'));
        } else {
             allBtns.forEach(b => {
                 if (b.dataset.id == activeThemeId || (activeThemeId === null && b.dataset.id === 'all')) {
                     b.classList.add('active');
                 } else {
                     b.classList.remove('active');
                 }
             });
        }
        
      }catch(err){
        catalog.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);text-align:center;">Error cargando sets — revisa la consola o el ID del set.</div>';
        console.error(err);
      }
    }

    function renderCatalog(data){
      const catalog = document.getElementById('catalog');
      catalog.innerHTML = '';
      const sets = data.results || [];
      if(sets.length===0){ catalog.innerHTML = '<div style="grid-column:1/-1;color:var(--muted);text-align:center;">No se encontraron sets con esos criterios.</div>'; return }

      sets.forEach(set => {
        const estPrice = estimatePrice(set.num_parts);
        const setnum = set.set_num;
        
        // Verifica si el set está en la colección y cuántas copias
        const qtyInCollection = (inventory[setnum] && inventory[setnum].qty) || 0;
        const statusText = qtyInCollection > 0 ? `En Colección (${qtyInCollection})` : 'No Coleccionado';
        const statusColor = qtyInCollection > 0 ? '#10b981' : 'var(--muted)';
        
        const el = document.createElement('article'); el.className='card';
        el.innerHTML = `
          <a href="detalles.html?set_num=${setnum}" style="text-decoration:none; color:inherit;">
              <div class='imgwrap'><img src='${set.set_img_url || ''}' alt='${escapeHtml(set.name)}' style='max-width:100%;max-height:100%;object-fit:contain;border-radius:10px'/></div>
          </a>
          <h4 class='product-name'>
             <a href="detalles.html?set_num=${setnum}" style="text-decoration:none; color:inherit;">${escapeHtml(set.name)}</a>
          </h4>
          <p class='product-desc'>ID: ${setnum || '—'} • Año: ${set.year_released || '—'} • Piezas: ${set.num_parts || '—'}</p>
          <div class='price-row'>
            <div class='price' style='color:${statusColor}'>${statusText}</div>
            <div style='display:flex;gap:8px'>
              <button class='btn tiny-btn add-btn' data-setnum='${setnum}' style="background:var(--accent); color:#081228;">Agregar</button>
            </div>
          </div>
        `;
        catalog.appendChild(el);
      });

      // add event listeners for buttons
      document.querySelectorAll('.add-btn').forEach(b => b.addEventListener('click', (e)=>{
        const id = e.currentTarget.dataset.setnum; 
        addToCollection(id); 
        e.currentTarget.innerText='¡Agregado! (+1)'; 
        setTimeout(()=>e.currentTarget.innerText='Agregar', 1200);
      }));
    }

    function renderPager(data){
      const pager = document.getElementById('pager');
      pager.innerHTML = '';
      const count = data.count || 0; const totalPages = Math.ceil(count / PAGE_SIZE);
      const info = document.createElement('div'); info.style.color='var(--muted)'; info.innerText = `Página ${currentPage} de ${totalPages} — ${count} sets encontrados`;
      const prev = document.createElement('button'); prev.className='tiny-btn'; prev.innerText='« Anterior'; prev.disabled = !data.previous;
      const next = document.createElement('button'); next.className='tiny-btn'; next.innerText='Siguiente »'; next.disabled = !data.next;
      prev.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; fetchAndRender(false); } });
      next.addEventListener('click', ()=>{ currentPage++; fetchAndRender(false); });
      pager.appendChild(prev); pager.appendChild(info); pager.appendChild(next);
    }

    // --- UI WIRING ---
    document.getElementById('reload').addEventListener('click', ()=>{ fetchAndRender(); });
    document.getElementById('search').addEventListener('input', (e)=>{ activeThemeId = null; });
    document.getElementById('search').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { 
        e.preventDefault(); 
        fetchAndRender();
      }
    });
    document.getElementById('sort').addEventListener('change', ()=>{ fetchAndRender(); });

    // Init
    (async function init(){ await loadThemes(); await fetchAndRender(); })();

  </script>
</body>
</html>